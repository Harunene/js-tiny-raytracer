
<html>
<head>

<script language="javascript" src="math.js"></script>
<script language="javascript" src="object.js"></script>

<script>

// 전역 옵션
var SCREEN_WIDTH = 300;
var SCREEN_HEIGHT = 300;
var FIELD_OF_VIEW = 40;
var REFLECTION_LEVEL = Infinity;


// 전역 변수
var SCREEN_DISTANCE;

var EPS = 0.0000001;
var canvas ;
var context ;

var eyeat ;
var eyepos ;
var eyeray ;
var eyecoord ;

var objects = [] ;
var light ;

var pix, imgdata ;

var x, y, xy ;

var refreshTimer ;  

var startTick ;

// 이벤트 정의
window.onload = function() {
  canvas = document.createElement("canvas");
  canvas.setAttribute('width', SCREEN_WIDTH);
  canvas.setAttribute('height', SCREEN_HEIGHT);
  document.body.appendChild(canvas);
  context = canvas.getContext("2d");
  context.fillStyle = "cornflowerblue";
  context.fillRect(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT);
  main();
}

// 메인 함수
function main()
{
  eyeat = new Point(0, 0, 0);
  eyepos = new Point(1700, -2400, 3100);
  eyeray = new Ray(eyepos, new Vector(eyepos, eyeat));
  light = new Vector(0, 0, 30000);
  eyecoord = new CoordinationSystem(eyeray, new Vector(0, 0, -1));
  
  objects.push( new Sphere( new Point(   0, -900,    0), 500, new Vector(1.0, 0.2, 0.2)) );
  objects.push( new Sphere( new Point( 900, -900, -400), 500, new Vector(0.2, 1.0, 0.2)) );
  objects.push( new Sphere( new Point(-900, -900, -400), 500, new Vector(0.2, 0.2, 1.0)) );
  objects.push( new Sphere( new Point(   0,    0, -600), 500, new Vector(0.2, 1.0, 1.0)) );
  objects.push( new Sphere( new Point( 900,    0,    0), 500, new Vector(1.0, 0.2, 1.0)) );
  objects.push( new Sphere( new Point(-900,    0,    0), 500, new Vector(1.0, 1.0, 0.2)) );
  objects.push( new Sphere( new Point(   0,  900,    0), 500, new Vector(0.5, 1.0, 0.2)) );
  objects.push( new Sphere( new Point( 900,  900, -400), 500, new Vector(0.2, 0.5, 1.0)) );
  objects.push( new Sphere( new Point(-900,  900, -400), 500, new Vector(1.0, 0.2, 0.5)) );
  objects.push( new Triangle( 
    new Point(3000, 3000, -500), 
    new Point(-3000, 3000, -500), 
    new Point(3000, -3000, -500), 
    new Vector(.2, .4, .8), 
    new Vector(.8, .2, .4), 
    new Vector(.4, .8, .2)
  ) );
  objects.push( new Triangle( 
    new Point(-3000, -3000, -500), 
    new Point(3000, -3000, -500), 
    new Point(-3000, 3000, -500), 
    new Vector(1, 1, 0), 
    new Vector(.4, .8, .2), 
    new Vector(.8, .2, .4)
  ) );
  objects.push( new Triangle( 
    new Point(15000, 15000, -800), 
    new Point(-15000, 15000, -800), 
    new Point(15000, -15000, -800), 
    new Vector(.644, .9375, .7929), 
    new Vector(.644, .9375, .7929), 
    new Vector(.644, .9375, .7929)
  ) );
  objects.push( new Triangle( 
    new Point(-15000, -15000, -800), 
    new Point(15000, -15000, -800), 
    new Point(-15000, 15000, -800), 
    new Vector(.644, .9375, .7929), 
    new Vector(.644, .9375, .7929), 
    new Vector(.644, .9375, .7929)
  ) );
  
  refreshTimer = setInterval("refresh()", 100);
  draw();
}


function refresh()
{
  context.putImageData(imgdata, 0,0);
  hello.innerText = Math.round(y/(SCREEN_HEIGHT)*100+50) + "%";
}

function draw()
{
  startTick = new Date();
  context.fillRect(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT) ;
  imgdata = context.getImageData(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT) ;
  pix = imgdata.data ;
  SCREEN_DISTANCE = SCREEN_WIDTH / (2*Math.tan(FIELD_OF_VIEW*Math.PI / 360)) ;
  y = -SCREEN_HEIGHT / 2 ;
  setTimeout("draw_inner()", 1) ;
}

function draw_inner()
{
  var delta = 1;

  for (var it = 0; it < delta; it++)
  {
    xy = 4*SCREEN_WIDTH*(y+SCREEN_HEIGHT/2);

    for (x = -SCREEN_WIDTH/2; x < SCREEN_WIDTH/2; x++, xy+=4)
    {
      tmpvec = new Vector(x, y, SCREEN_DISTANCE);
      tmpray = new Ray(eyepos, eyecoord.worldize(tmpvec));
      tmpcolor = getColor(tmpray, REFLECTION_LEVEL);
      pix[xy] = tmpcolor.x*255; pix[xy+1] = tmpcolor.y*255; pix[xy+2] = tmpcolor.z*255;
    }
    if (y <= SCREEN_HEIGHT/2)
    {
      setTimeout("draw_inner()", 1);
    }
    else
    {
      refresh();
      hello.innerText += " " + ((new Date()).getTime() - startTick.getTime()) + "ms";
      clearInterval(refreshTimer);
    }

    y++;
  }
}

function getCollisionObject(ray, objects)
{
  var min_t = Infinity;
  var min_index = undefined;
  var length = objects.length;
  for (var i = 0; i < length; i++)
  {
    if (objects[i].checkIntersection(ray))
    {
      if (min_t > objects[i].firstT && objects[i].firstT > EPS)
      {
        min_t = objects[i].firstT;
        min_index = i;
      }
    }
  }
  return min_index;
}

function checkShadowObject(ray, objects, index_of_me)
{
  var min_t = Infinity;
  var min_index = undefined;
  var length = objects.length;
  for (var i = 0; i < length; i++)
  {
    if (i == index_of_me) continue;
    if (objects[i].checkIntersection(ray))
    {
      if (min_t > objects[i].firstT && objects[i].firstT > 0 && objects[i].firstT < 1)
      {
        min_t = objects[i].firstT;
        min_index = i;
      }
    }
  }
  return !min_index;
}

function getColor(tmpray, recursive)
{
  var tmpcolor = new Vector(1, 1, 1);
  var obj;
  var i;
  
  i = getCollisionObject(tmpray, objects);
  if (i == undefined)
    return tmpcolor;
    
  obj = objects[i];

  tmpcolor=obj.color.multi(obj.getGradient());
  
  var shadow_ray = new Ray(light, new Vector(light, obj.firstPoint));
  var shadow_value = 1;
  var shadow_object = obj;
  var highlight_value = 0;
  
  if (checkShadowObject(shadow_ray, objects, i))
    highlight_value += shadow_object.getHighLight(tmpray.O);
  else
    shadow_value *= 0.7;
    
  highlight_value = (highlight_value > 1) ? 1 : highlight_value;
  tmpcolor = tmpcolor.multi(1-highlight_value).plus(new Vector(1, 1, 1).multi(highlight_value));
  tmpcolor = tmpcolor.multi(shadow_value);
  if (tmpcolor.x > 1) tmpcolor.x = 1;
  if (tmpcolor.y > 1) tmpcolor.y = 1;
  if (tmpcolor.z > 1) tmpcolor.z = 1;
  
  if (recursive > 0)
  {
    tmpcolor = getColor(new Ray(
      shadow_object.firstPoint, shadow_object.getReflectVector(tmpray.V.minus())
    ), recursive-1).multi(0.3).plus(tmpcolor.multi((1-0.3)));
  }
  
  return tmpcolor;
}

</script>

<script>
function error(msg)
{
  document.write("에러발생 : ");
  document.write(msg);
  return -1;
}
function puts(msg)
{
  console.innerText = msg + "\n" + console.innerText;
}
function RGB(colorvec)
{
  return "rgb(" + parseInt(colorvec.x*256) + "," + parseInt(colorvec.y*256) + "," + parseInt(colorvec.z*256) + ")";
}
</script>

</head>

<body>

<div id="hello">
</div>
<div id="console">
</div>

